#!/usr/bin/env sh

set -e

BASE_DIR="$(cd "$(dirname "$0")"; pwd)"
RESTART_CODE=123

[ -d "$BASE_DIR/jre" ] && JAVA_HOME=$BASE_DIR/jre
[ -z "$ROUTR_LOG4J2" ] && ROUTR_LOG4J2=config/log4j2.yml

# Enable for performance testing
# ROUTR_JAVA_OPTS=-Dgraal.TrufflePerformanceWarningsAreFatal=true
# When we bring support for GraalVM 19.3 we can try this option to avoid
# compilation issues
# ROUTR_JAVA_OPTS=$ROUTR_JAVA_OPTS -Dgraal.TruffleLanguageAgnosticInlining=true \
run() {
    cd $BASE_DIR
    $JAVA_HOME/bin/java \
    -DROUTR_DATA=$ROUTR_DATA \
    -Dlog4j.configurationFile=$ROUTR_LOG4J2 \
    -Dpolyglot.engine.Mode=throughput \
    -Dgraal.TruffleFunctionInlining=false \
    -Dgraal.CompilationFailureAction=Silent \
    -Dpolyglot.js.experimental-foreign-object-prototype=true \
    -Dpolyglot.js.nashorn-compat=true \
    -Dnashorn.args="--no-deprecation-warning" \
    $ROUTR_JAVA_OPTS \
    -classpath "$BASE_DIR/libs/*" \
    io.routr.core.Launcher
    return $?
}

if [ -f /.dockerenv ]; then
  [ -z "$ROUTR_EXTERN_ADDR" ] && { echo "Must define environment variable ROUTR_EXTERN_ADDR when running inside a container"; exit 1; }
  [ -z "$ROUTR_LOCALNETS" ] && export ROUTR_LOCALNETS=$(ip addr show eth0 | grep "inet\b" | awk '{print $2}')
fi

[ -z "$JAVA_HOME" ] && { echo "Could not find a runtime environment. Please setup environment variable JAVA_HOME"; exit 1; }

{
  until false; do
    run
    exit_code=$?
    if [ $exit_code -ne $RESTART_CODE ] ; then
      break
    fi
  done
} || { # your 'catch' block
    echo 'Done.'
}
